<div class='codemirror-container' style='{{#height}}height: {{height}};{{/height}}'>
	<textarea></textarea>
</div>

<script>
	var keyNames = {
		'13': 'enter'
	};

	component.exports = {
		init: function () {
			var component = this, mode, editor, doc, updating;

			mode = this.get( 'mode' );

			if ( mode === 'json' ) {
				mode = {
					name: 'javascript',
					json: true
				};
			}

			editor = CodeMirror.fromTextArea( this.find( 'textarea' ), {
				mode: mode,
				theme: this.get( 'theme' ) || 'ractive',
				lineWrapping: true,
				lineNumbers: true,
				keyMap: 'sublime'
			});
			doc = editor.getDoc();

			window.editor = editor;

			editor.on( 'change', function () {
				if ( updating ) {
					return;
				}

				updating = true;
				component.set( 'value', editor.getValue() );
				updating = false;
			});

			setTimeout( function () {
				component.fire( 'shiftEnter' );
			}, 500 );

			editor.on( 'keydown', function ( editor, event ) {
				var name = CodeMirror.keyNames[ event.which ];

				if ( name ) {
					component.fire( name.toLowerCase(), {
						component: component,
						shift: event.shiftKey,
						original: event
					});
				}

				return;
			});

			this.observe( 'value', function ( value ) {
				if ( updating ) {
					return;
				}

				updating = true;
				editor.setValue( value || '' );
				updating = false;
			});

			this.on( 'teardown', function () {
				editor.toTextArea();
			});
		}
	};
</script>
